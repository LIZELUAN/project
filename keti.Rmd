---
title: "GNBF6010 seruat"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
setwd("C:/Users/may/Desktop/keti")
# save wanted RData in a file
# save(data, pbmc, all.genes, file = "my.RData")
# or save all data
# save.image(file="allData")
# load(file = "my.Rdata")
rm(data)
library(Seurat)
library(dplyr)
library(patchwork)
library("data.table")
library(scuttle)
library(ggplot2)
memory.limit(size=100000000)
load("C:/Users/may/Desktop/keti/D3.RData")
```

```{r}
# Load the PBMC dataset
data <- readSparseCounts('data.raw.matrix.txt')
rm(data)
# Initialize the Seurat object with the raw (non-normalized data).
head(pbmc@meta.data)
pbmc <-CreateSeuratObject(counts = data, project = "pbmc3k", min.cells = 3, min.features = 200)
pbmc
data[100:200,]
data[c("CD3D", "TCL1A", "MS4A1"), 1:30]
```



Pre-processing
QC metrics
The [[ operator can add columns to object metadata. This is a great place to stash QC stats
```{r}

pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
pbmc@active.ident
pbmc[["Annotation"]] <- pbmc@active.ident
head(pbmc@meta.data,10)
pbmc[["RNA"]]@counts[c("CD3D", "TCL1A", "MS4A1"), 1:30]
```

Visualize QC metrics as a violin plot
```{r}
VlnPlot(pbmc, features = "nFeature_RNA") & geom_hline(yintercept = 200)
```


FeatureScatter is typically used to visualize feature-feature relationships, but can be used
for anything calculated by the object, i.e. columns in object metadata, PC scores etc.
```{r}
plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot2
plot1 + plot2
pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
```
#Normalizing the data
```{r}
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)
# or: pbmc <- NormalizeData(pbmc)
#normalized.data <- pbmc[["RNA"]]@data
#normalized.data[1:10,1:2]
```

# feature selection
```{r}
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without lab
plot1 <- VariableFeaturePlot(pbmc)
LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
```




# scale data
```{r}
all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)
#scale.data <- pbmc[["RNA"]]@scale.data
#scale.data[1:10,1:4]
#rm(scale.data)

```
# Perform linear dimensional reduction
```{r}
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))

# Examine and visualize PCA results a few different ways
print(pbmc[["pca"]], dims = 1:50, nfeatures = 5)
VizDimLoadings(pbmc, dims = 1:2, reduction = "pca")
DimPlot(pbmc, reduction = "pca")
DimHeatmap(pbmc, dims = 1, cells = 500, balanced = TRUE)
DimHeatmap(pbmc, dims = 1:15, cells = 500, balanced = TRUE)
```
#Determine the ‘dimensionality’ of the dataset
```{r}
# NOTE: This process can take a long time for big datasets, comment out for expediency. More
# approximate techniques such as those implemented in ElbowPlot() can be used to reduce
# computation time
pbmc <- JackStraw(pbmc, num.replicate = 100)
pbmc <- ScoreJackStraw(pbmc, dims = 1:20)
JackStrawPlot(pbmc, dims = 1:20)
ElbowPlot(pbmc)
```



Cluster the cells
```{r}
pbmc <- FindNeighbors(pbmc, dims = 1:6)
pbmc <- FindClusters(pbmc, resolution = 0.4)
head(Idents(pbmc), 5)
```

Run non-linear dimensional reduction (UMAP/tSNE)
```{r}
pbmc <- RunTSNE(pbmc, dims = 1:6)
# note that you can set `label = TRUE` or use the LabelClusters function to help label
# individual clusters
DimPlot(pbmc, reduction = "tsne")
# saveRDS(pbmc, file = "./pbmc_tutorial.rds")
# library("png")
```
Finding differentially expressed features (cluster biomarkers)
# find all markers of cluster 2
```{r}
cluster3.markers <- FindMarkers(pbmc, ident.1 = 3, min.pct = 0.25)
head(cluster3.markers, n = 5)
```
# find all markers distinguishing cluster 5 from clusters 0 and 3
```{r}
cluster5.markers <- FindMarkers(pbmc, ident.1 = 5, ident.2 = c(0, 3), min.pct = 0.25)
head(cluster5.markers, n = 5)
```
# find markers for every cluster compared to all remaining cells, report only the positive
# ones
```{r}
pbmc.markers <- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
pbmc.markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC)
```

ROC test returns the ‘classification power’ for any individual marker (ranging from 0 - random, to 1 - perfect).
```{r}
cluster14.markers <- FindMarkers(pbmc, ident.1 = 14, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
cluster14.markers
VlnPlot(pbmc, features = c("MS4A1", "CD79A"))
```
# you can plot raw counts as well


```{r}
VlnPlot(pbmc, features = c("NKG7", "PF4"), slot = "counts", log = TRUE)
FeaturePlot(pbmc, features = c( "CD3D","CD3E","CD2")) #Tcell
FeaturePlot(pbmc, features = c( "CD14","CD68","LYZ","FCGR3A")) #Monocytic
FeaturePlot(pbmc, features = c( "DPP4","AR","KRT18","KRT8")) #lUMINAL
FeaturePlot(pbmc, features = c( "KRT14","KRT5")) #Basal/intermediate
FeaturePlot(pbmc, features = c( "ACTA2","RGS5")) #Fibroblast
FeaturePlot(pbmc, features = c( "COL2A1","CYTL1")) 
FeaturePlot(pbmc, features = c( "SMA","IGFBP3")) 

FeaturePlot(pbmc, features = c( "ENG","VWF")) #Endothelial
FeaturePlot(pbmc, features = c( "MS4A2","TPSAB1","TPSB2")) #Mast
FeaturePlot(pbmc, features = c( "CD79A")) #B CELL
FeaturePlot(pbmc, features = c("CD3D", "CD79A", "C1QA", "CD163", "EPCAM", "PECAM1", "VIM", "DCN","S100A9"), pt.size=0.01)
```

DoHeatmap() generates an expression heatmap for given cells and features.
```{r}
pbmc.markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC) -> top10
DoHeatmap(pbmc, features = top10$gene) + NoLegend()
```



Assigning cell type identity to clusters

```{r}
new.cluster.ids <- c("Luminal", "Luminal","Luminal","T cell","Luminal","Endothelial","Luminal","Monocytic","Fibroblast","Luminal","Mast","Basal/Intermediate","Luminal","B cell","Chondrocyte","Endothelial")
pbmc@active.ident
#new.cluster.ids <- pred.scRNA$pruned.labels
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)
pbmc <- RunTSNE(pbmc, dims = 1:6)
DimPlot(pbmc, reduction = "tsne", label = TRUE)+ NoLegend() + scale_color_manual(values = c("#00DDA2", "deeppink","goldenrod","purple","#33FF33","#00A9FF","red","yellow","gray"))

```
```{r}
features<-c('ACTA2','PECAM1','VWF','ENG','CMA1','MS4A2','TPSAB1','TPSB2','AR','KRT19','KRT18','KRT8','TP63','KRT14','KRT5','LYZ','FCGR3A','CSF1R','CD68','CD163','CD14','UCHL1','HAVCR2','PDCD1','CTLA4','CD8A','SELL','PTPRC','CD4','BTLA','IL2RA','IL7R','CCR7','CD28','CD27','SLAMF1','DPP4','CD7','CD2','CD3G','CD3E','CD3D')
features<-rev(features)
d<-DotPlot(
  object=pbmc,
  assay = NULL,
  features,
  cols = c("lightgrey", "blue"),
  col.min = -2.5,
  col.max = 2.5,
  dot.min = 0,
  dot.scale = 6,
  idents = NULL,
  group.by = NULL,
  split.by = NULL,
  cluster.idents = TRUE,
  scale = TRUE,
  scale.by = "radius",
  scale.min = NA,
  scale.max = NA
)
j<-d+coord_flip()+theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5,size=8),axis.text.y = element_text(size=5))

j


```
T cell
```{r}
sce = pbmc[, Idents(pbmc) %in% c( "T cell")]
sce <- NormalizeData(sce, normalization.method = "LogNormalize", scale.factor = 1e4) 
sce <- FindVariableFeatures(sce, selection.method = 'vst', nfeatures = 2000)
all.genes <- rownames(sce)
sce <- ScaleData(sce,features = all.genes)

sce <- RunPCA(sce, features = VariableFeatures(object = sce))

sce <- FindNeighbors(sce, dims = 1:8)
sce <- FindClusters(sce, resolution = 0.4)
# Look at cluster IDs of the first 5 cells

sce <- RunTSNE(sce, dims = 1:8)
DimPlot(sce, reduction = 'tsne',label=T)
cluster5.markers <- FindMarkers(sce, ident.1 = 5, ident.2 = 0,min.pct = 0.25,only.pos = TRUE )
```
 [1] "CD8+ T-cells" "CD8+ T-cells" "NK cells"    
 [4] "CD4+ T-cells" "CD8+ T-cells" "CD8+ T-cells"
 [7] "CD4+ T-cells" "CD8+ T-cells" "CD8+ T-cells"
[10] "CD8+ T-cells"

```{r}
new.cluster.ids <-c("CD4+ Tcov","CD8+ T effector cell","CD8+ T effector cell","CD4+ Treg","CD8+ T naive cell", "CD4+ Tcov","CD4+ Tcov","CD8+ T effector cell","CD8+ T effector cell","CD4+ Tcov")
names(new.cluster.ids) <- levels(sce)
levels(sce)
sce <- RenameIdents(sce,new.cluster.ids)


FeaturePlot(sce, features = c( "CD4","GZMA","CD8A","FOXP3","CCR7","LAG3"))

FeaturePlot(sce, features = c( "FOXP3","IL2RA","CTLA4","IKZF2","IKZF4","TNFRSF18"))

#CD8+
FeaturePlot(sce, features = c( "GZMH", "GZMB", "GZMA", "PRF1"))

#CD8+ naive
VlnPlot(sce, features = c( "CD45RA","CD62L","CD127","CDR7","CCR7","ACACB"))
#CD8+ effector
VlnPlot(sce, features = c( "CCL5"))


#CD8+
VlnPlot(sce, features = c( "KLK3"))
par(mfrow=c(2,3))
FeaturePlot(sce, features = c( "CD4","CD8A","CCR7","GZMA","FOXP3","LAG3"))

#CD4+
VlnPlot(sce, features = c( "CD4"))

#Treg
VlnPlot(sce, features = c( "FOXP3","CD25"),pt.size=0)

#注释细胞类型辅助手段
if (!require("BiocManager", quiet = TRUE))
    install.packages("BiocManager")

BiocManager::install("BiocParallel")

library(celldex)
ref <- BlueprintEncodeData()
library(SingleR)
library(BiocParallel)


pre.scRNA <- SingleR(test = sce@assays$RNA@data, ref = ref, labels = ref$label.main,clusters = sce@active.ident)
#鉴定各聚类的细胞类型，可选择method 参数为“single”，返回每个细胞的鉴定结果。clusters参数指定的各聚类的名称
pre.scRNA$pruned.labels#到此为止就可以了

VlnPlot(sce, features = c("CD8A", "CD4"),pt.size=0)
VlnPlot(sce, features = c("AR"))
VlnPlot(sce, features = c("GZMH", "GZMB", "GZMA", "PRF1","IFN"))
VlnPlot(sce, features = c("KLK3"))
VlnPlot(sce, features = c("FOLH1"))
VlnPlot(sce, features = c("FOXP3","IL2RA","STAT5A","CTLA4"))
VlnPlot(sce1, features = c("CCL2"),pt.size=0)
par(mfrow=c(2,3))


VlnPlot(pbmc,features=c("COL3A1",'MS4A1'),pt.size=0)





```


Epithelial cell
```{r}
rm(sce)
rm(pbmc)

rm(cluster14.markers)
sce1 = pbmc[, Idents(pbmc) %in% c( "Basal/Intermediate","Luminal")]
sce1 <- NormalizeData(sce1, normalization.method = "LogNormalize", scale.factor = 1e4) 
sce1 <- FindVariableFeatures(sce1, selection.method = 'vst', nfeatures = 2000)
all.genes <- rownames(sce1)
sce1 <- ScaleData(sce1,features = all.genes)

sce1 <- RunPCA(sce1, features = VariableFeatures(object = sce1))

sce1 <- FindNeighbors(sce1, dims = 1:9)
sce1 <- FindClusters(sce1, resolution = 0.4)
# Look at cluster IDs of the first 5 cells
# real:(attention) 
#sce1 <- RunTSNE(sce1, dims = 1:10) resolution=0.4

#sce1[["RNA"]]@scale.data[1:9,1:4]
sce1 <- RunTSNE(sce1, dims = 1:9)
DimPlot(sce1, reduction = 'tsne',label=TRUE)
#basal
FeaturePlot(sce1, features = c( "KRT5","KRT14","KRT19","TP63"))
#CELL CYCLE
FeaturePlot(sce1, features = c( "CCNB1","CENPF","PTTG1","CDC20"))

```








```{r}
#不重要（参考）
## 提取 tSNE 降维信息到 tsne 
library(tidyverse)
tsne = pbmc@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(tx = pbmc@meta.data$seurat_clusters)

## 用 ggplot 绘图（假设所有的细胞被分为 6 个 cluster）
jpeg(file = "tSNE.by_cluster.jpg", width = 7, height = 7, units = "in", res = 600)
myplot <- ggplot(tsne, aes(x = tSNE_1, y = tSNE_2, color = tx)) + 
      geom_point(size = 0.2, alpha = 1) + 
      scale_color_manual(values=c("1" = "cyan3","10"="cyan3","5"= "cyan3","0" = "cyan3","9" = "cyan3","3" = "cyan3","11" = "purple",  "4" = "cyan3", "5" = "cyan3", "6" = "cyan3","7" = "cyan3","14" = "goldenrod","8"="goldenrod","13"="deepskyblue","12"="yellow green","2"="deeppink1","16"="yellow", "15" = "red"))
myplot + theme_bw()







```


```{r}
#注释细胞类型辅助手段
if (!require("BiocManager", quiet = TRUE))
    install.packages("BiocManager")

BiocManager::install("BiocParallel")

library(celldex)
ref <- HumanPrimaryCellAtlasData()
library(SingleR)
library(BiocParallel)

#pred.scRNA <- SingleR(test = pbmc@assays$RNA@data, ref = ref,labels = ref$label.main, method=single, fine.tune = TRUE, BPPARAM = SnowParam(40))
pred.scRNA <- SingleR(test = pbmc@assays$RNA@data, ref = ref, labels = ref$label.main,clusters = pbmc@active.ident)
#鉴定各聚类的细胞类型，可选择method 参数为“single”，返回每个细胞的鉴定结果。clusters参数指定的各聚类的名称
pred.scRNA$pruned.labels#到此为止就可以了

#查看注释准确性 
pdf(file="10.celllabel.pdf",width=10,height=10)   
plotScoreHeatmap(pred.scRNA, clusters=pred.scRNA@rownames, fontsize.row = 9,show_colnames = T)
dev.off()

#绘制带cell label的tsne和umap图
new.cluster.ids <-c("Luminal","Luminal","Luminal","T cell","Luminal", "Endothelial cell","Luminal","Monocyte","Fibroblast","Luminal","Mast", "Basal/Intermediate","Luminal","B cell","Chondrocyte",      "Endothelial cell")
names(new.cluster.ids) <- levels(scRNA)
levels(scRNA)
# 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
scRNA <- RenameIdents(scRNA,new.cluster.ids)
levels(scRNA)

pdf(file="10.TSNE_lable.pdf",width=6.5,height=6)
TSNEPlot(object = scRNA1, pt.size = 0.5, label = TRUE)  
dev.off()

pdf(file="10.uMAP_label.pdf",width=6.5,height=6)
DimPlot(scRNA1, reduction = "umap",pt.size=0.5,label = TRUE)
dev.off()


```

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("CHETAH")

```

fibroblast cell
```{r}
sce3 = pbmc[, Idents(pbmc) %in% c( "Fibroblast")]
sce3 <- NormalizeData(sce3, normalization.method = "LogNormalize", scale.factor = 1e4) 
sce3 <- FindVariableFeatures(sce3, selection.method = 'vst', nfeatures = 2000)
all.genes <- rownames(sce3)
sce3 <- ScaleData(sce3,features = all.genes)

sce3 <- RunPCA(sce3, features = VariableFeatures(object = sce3))

sce3 <- FindNeighbors(sce3, dims = 1:9)
sce3 <- FindClusters(sce3, resolution = 0.15)
# Look at cluster IDs of the first 5 cells

sce3 <- RunTSNE(sce3, dims = 1:9)
DimPlot(sce3, reduction = 'tsne')

FeaturePlot(sce3, features = c( "FAP","S100A4","SPARC","ACTA2","PDGFRA","PDGFRB","CAV1","VIM"))




```




Endothelial cell
```{r}
sce4 = pbmc[, Idents(pbmc) %in% c( "Endothelial")]
sce4 <- NormalizeData(sce4, normalization.method = "LogNormalize", scale.factor = 1e4) 
sce4 <- FindVariableFeatures(sce4, selection.method = 'vst', nfeatures = 2000)
all.genes <- rownames(sce4)
sce4 <- ScaleData(sce4,features = all.genes)

sce4 <- RunPCA(sce4, features = VariableFeatures(object = sce4))

sce4 <- FindNeighbors(sce4, dims = 1:9)
sce4 <- FindClusters(sce4, resolution = 0.1
                     )
# Look at cluster IDs of the first 5 cells

sce4 <- RunTSNE(sce4, dims = 1:9)
DimPlot(sce4, reduction = 'tsne')

#gene markers
FeaturePlot(sce4, features = c( "PECAM1","FLT1","PDPN","S100A4","THY1","ACTA2"))

#aEC
VlnPlot(sce4, features = c("S100A4","THY1","ACTA2"))



#Other endothelial cell
FeaturePlot(sce4, features = c( "CCL14","ACKR1","COL4A1","IGF2","NOTCH3"))

FeaturePlot(sce4, features = c( "SEMA6D","BMP2","COL27A1","WNT2B","PRR3","PVR","TNFRSF25","JAG2"))

```

```{r}
new.cluster.ids <- c("Endothelial","aEC","aEC","aEC","Endothelial","Endothelial")
names(new.cluster.ids) <- levels(sce4)
sce4 <- RenameIdents(sce4, new.cluster.ids)
sce4 <- RunTSNE(sce4, dims = 1:9)
DimPlot(sce4, reduction = "tsne", label = TRUE)
sce4@active.ident
sce4[["Annotation"]] <- sce4@active.ident
sce4@meta.data
```

细胞通讯cellphoneDB
```{r}
rm(data)
rm(pbmc)
write.table(as.matrix(pbmc.combined@assays$RNA@data), 'data.txt', sep='\t', quote=F)
meta_data <- cbind(rownames(pbmc.combined@meta.data), pbmc@meta.data[,'Annotation', drop=F])  
meta_data <- as.matrix(meta_data)
meta_dat[is.na(meta_data)] = "Unkown" #  细胞类型中不能有NA

write.table(meta_data, 'meta.txt', sep='\t', quote=F, row.names=F)

pbmc='D:\\SingleCell\\out\\' ##  outs 文件放在这里了。

library(psych)
library(qgraph)
library(igraph)
library(tidyverse)

netf<- "count_network.txt"
mynet <- read.delim(paste0(pbmc,"count_network.txt"), check.names = FALSE)
table(mynet$count)
mynet %>% filter(count>0) -> mynet  # 有零会报错
head(mynet)

net<- graph_from_data_frame(mynet)

plot(net)
















```




```{r}
library(iTALK)
library(Seurat)
library(Matrix)
library(dplyr)
rm(pbmc.combined)
pbmc.combined <- merge(pbmc[, Idents(pbmc) %in% c("Luminal","T cell","Monocytic","Fibroblast","Mast","Basal/Intermediate","B cell","Chondrocyte")],y=sce4,project = "PBMC12K")
pbmc.combined[["Annotation"]]<- pbmc.combined@active.ident
pbmc.combined@meta.data
iTalk_data <- as.data.frame(t(pbmc.combined@assays$RNA@counts))
iTalk_data$cell_type<-pbmc.combined@meta.data$Annotation
pbmc.combined[[ "group"]] <- pbmc.combined$orig.ident 
iTalk_data$compare_group <- pbmc.combined@meta.data$group
unique(iTalk_data$cell_type)
unique(iTalk_data$compare_group)
my10colors <- my36colors <-c('#E5D2DD', '#53A85F', '#F1BB72', '#F3B1A0', '#D6E7A3', '#57C3F3', '#476D87', '#E95C59', '#E59CC4', '#AB3282')
highly_exprs_genes <- rawParse(iTalk_data, top_genes=5, stats="mean")
comm_list<-c('growth factor','other','cytokine','checkpoint')
cell_types <- unique(iTalk_data$cell_type)
cell_col <- structure(my10colors[1:length(cell_types)], names=cell_types)

iTalk_res <- NULL
for(comm_type in comm_list){
  res_cat <- FindLR(highly_exprs_genes, datatype='mean count', comm_type=comm_type)
  iTalk_res <- rbind(iTalk_res, res_cat)
}

iTalk_res <- iTalk_res[order(iTalk_res$cell_from_mean_exprs*iTalk_res$cell_to_mean_exprs,decreasing=T),][1:20,]        
#可视化
NetView(iTalk_res,col=cell_col,vertex.label.cex=1,arrow.width=1,edge.max.width=5)

LRPlot(iTalk_res[1:20,],datatype='mean count',cell_col=cell_col,link.arr.lwd=iTalk_res$cell_from_mean_exprs[1:20],link.arr.width=iTalk_res$cell_to_mean_exprs[1:20])
```


```{r}
library(tidyverse)
library(RColorBrewer)
library(scales)
library(igraph)
pvalues<-read.table("./out/pvalues.txt",header = T,sep = "\t",stringsAsFactors = F)
pvalues=pvalues[,12:dim(pvalues)[2]]
statdf=as.data.frame(colSums(pvalues < 0.05))
colnames(statdf)=c("number")
statdf$indexb=str_replace(rownames(statdf),"^.*\.","")
statdf$indexa=str_replace(rownames(statdf),"\..*$","")
rankname=sort(unique(statdf$indexa)) 
A=c()
B=c()
C=c()
remaining=rankname
for (i in rankname[-6]) {
  remaining=setdiff(remaining,i)
  for (j in remaining) {
    count=statdf[statdf$indexa == i & statdf$indexb == j,"number"]+
      statdf[statdf$indexb == i & statdf$indexa == j,"number"]
    A=append(A,i)
    B=append(B,j)
    C=append(C,count)
  }
}
statdf2=data.frame(indexa=A,indexb=B,number=C)
statdf2=statdf2 %>% rbind(statdf[statdf$indexa==statdf$indexb,c("indexa","indexb","number")])
statdf2=statdf2[statdf2$number > 0,] #过滤掉值为0的观测
#设置节点和连线的颜色
color1=c("#8DD3C7", "#FDB462", "#B3DE69", "#FCCDE5", "#D9D9D9", "#BC80BD")
names(color1)=rankname
color2=colorRampPalette(brewer.pal(9, "Reds")[3:7])(20) #将颜色分成多少份，取决于互作关系数目的最大值
names(color2)=1:20 #每一份颜色用对应的数字命名
#做网络图
##下面的四行代码相对固定
net <- graph_from_data_frame(statdf2[,c("indexa","indexb","number")])
edge.start <- igraph::ends(net, es=igraph::E(net), names=FALSE)
group <-  cluster_optimal(net)
coords <- layout_in_circle(net, order = order(membership(group)))
E(net)$width <- E(net)$number / 2 #将数值映射到连线的宽度，有时还需要微调，这里除以2就是这个目的
E(net)$color <- color2[as.character(ifelse(E(net)$number > 20,20,E(net)$number))] #用前面设置好的颜色赋给连线，颜色深浅对应数值大小
E(net)$label = E(net)$number #连线的标注
E(net)$label.color <- "black" #连线标注的颜色
V(net)$label.color <- "black" #节点标注的颜色
V(net)$color <- color1[names(V(net))] #节点的填充颜色，前面已经设置了；V(net)返回节点信息
#调整节点位置的线条角度
##如果没有这两行代码，节点位置的圆圈是向右的
loop.angle<-ifelse(coords[igraph::V(net),1]>0,-atan(coords[igraph::V(net),2]/coords[igraph::V(net),1]),pi-atan(coords[igraph::V(net),2]/coords[igraph::V(net),1]))
igraph::E(net)$loop.angle[which(edge.start[,2]==edge.start[,1])] <- loop.angle[edge.start[which(edge.start[,2]==edge.start[,1]),1]]
#pdf("interaction.num.3.pdf",width = 6,height = 6)
plot(net,
     edge.arrow.size = 0, #连线不带箭头
     edge.curved = 0, #连线不弯曲
     vertex.frame.color = "black", #节点外框颜色
     layout = coords,
     vertex.label.cex = 1, #节点标注字体大小
     vertex.size = 30) #节点大小
#dev.off()

```










